<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lease vs Buy Decision Engine - Aladdin Finance</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #060d15;
            --card: #0e1a27;
            --text: #eaf2f9;
            --accent: #4db3ff;
            --muted: #94a8bd;
            --green: #2ecc71;
            --red: #ff4d4d;
            --border: #1a2a38;
        }

        body.light {
            --bg: #f4f7fb;
            --card: #ffffff;
            --text: #0b1622;
            --accent: #1f4e79;
            --muted: #5c6c7a;
            --border: #e0e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: 0.35s ease;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            gap: 28px;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            background: linear-gradient(135deg, rgba(13, 26, 38, 0.6), rgba(30, 40, 50, 0.4));
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .logo {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent), #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .toggle {
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            border: none;
            transition: 0.3s;
        }

        .toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(77, 179, 255, 0.3);
        }

        /* CARDS */
        .card, .chart-card {
            background: linear-gradient(135deg, var(--card), rgba(30, 40, 50, 0.5));
            padding: 28px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card.show, .chart-card.show {
            opacity: 1;
            transform: translateY(0);
        }

        .card:hover, .chart-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* INPUTS GRID */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 700;
            letter-spacing: 0.4px;
            text-transform: uppercase;
        }

        input[type="text"],
        input[type="number"] {
            padding: 12px 14px;
            border-radius: 10px;
            border: 1.5px solid var(--border);
            background: rgba(10, 24, 38, 0.5);
            color: var(--text);
            font-weight: 700;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            transition: 0.25s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--card);
            box-shadow: 0 0 12px rgba(77, 179, 255, 0.2);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(77, 179, 255, 0.4);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(77, 179, 255, 0.4);
        }

        .micro {
            font-size: 11px;
            color: var(--accent);
            font-weight: 700;
            min-height: 14px;
        }

        /* DECISION PANEL */
        .decision-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 10px;
        }

        .decision-metric {
            background: rgba(77, 179, 255, 0.1);
            border: 1px solid rgba(77, 179, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .metric-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 900;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .metric-insight {
            font-size: 12px;
            color: var(--text);
            line-height: 1.5;
        }

        /* DECISION SCORE */
        .score-section {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, rgba(77, 179, 255, 0.1), rgba(155, 89, 182, 0.1));
            border-radius: 16px;
            border: 1px solid rgba(77, 179, 255, 0.2);
        }

        .score-gauge {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px rgba(77, 179, 255, 0.2);
        }

        .gauge-inner {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: var(--card);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: 900;
            box-shadow: inset 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .score-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 700;
            margin-top: 8px;
        }

        .score-text {
            font-size: 16px;
            color: var(--text);
            margin-top: 16px;
            line-height: 1.6;
            min-height: 50px;
        }

        /* CHARTS GRID */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
            gap: 24px;
        }

        .chart-card {
            position: relative;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 16px;
        }

        .chart-insight {
            font-size: 13px;
            color: var(--muted);
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            line-height: 1.6;
        }

        /* RECOMMENDATIONS */
        .recommendations {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(52, 152, 219, 0.1));
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .recommendation-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--green);
            margin-bottom: 12px;
        }

        .recommendation-item {
            font-size: 13px;
            color: var(--text);
            padding: 8px 0;
            line-height: 1.6;
            border-bottom: 1px solid rgba(46, 204, 113, 0.1);
        }

        .recommendation-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .card, .chart-card {
                padding: 16px;
            }

            .chart-container {
                height: 250px;
            }

            .score-gauge {
                width: 140px;
                height: 140px;
            }

            .gauge-inner {
                width: 110px;
                height: 110px;
                font-size: 28px;
            }
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <div class="header">
        <div class="logo"> Lease vs Buy Decision Engine</div>
        <button class="toggle" onclick="toggleTheme()">
            <span id="theme-icon"></span> <span id="theme-text">Dark</span>
        </button>
    </div>

    <div class="container">

        <!-- INPUT PARAMETERS -->
        <div class="card">
            <div class="card-title"> Financial Parameters</div>
            <div class="grid">
                <div class="field">
                    <label>Lease Amount ()</label>
                    <input id="leaseAmount" type="text" value="2000000">
                    <input type="range" id="leaseAmountRange" min="100000" max="5000000" step="50000" value="2000000">
                </div>

                <div class="field">
                    <label>Loan Amount ()</label>
                    <input id="loanAmount" type="text" value="1500000">
                    <input type="range" id="loanAmountRange" min="0" max="3000000" step="50000" value="1500000">
                </div>

                <div class="field">
                    <label>Loan Interest Rate (%)</label>
                    <input id="loanRate" type="text" value="8.5">
                    <input type="range" id="loanRateRange" min="1" max="20" step="0.1" value="8.5">
                </div>

                <div class="field">
                    <label>Opportunity Cost (%)</label>
                    <input id="oppRate" type="text" value="12">
                    <input type="range" id="oppRateRange" min="1" max="20" step="0.1" value="12">
                </div>

                <div class="field">
                    <label>Risk Premium (%)</label>
                    <input id="riskPremium" type="text" value="3">
                    <input type="range" id="riskPremiumRange" min="0" max="20" step="0.1" value="3">
                </div>

                <div class="field">
                    <label>Market Rent ()</label>
                    <input id="marketRent" type="text" value="45000">
                    <input type="range" id="marketRentRange" min="5000" max="100000" step="1000" value="45000">
                </div>

                <div class="field">
                    <label>Monthly Maintenance ()</label>
                    <input id="maintenance" type="text" value="5000">
                    <input type="range" id="maintenanceRange" min="0" max="20000" step="500" value="5000">
                </div>

                <div class="field">
                    <label>Rent Increment (%)</label>
                    <input id="rentIncrement" type="text" value="5">
                    <input type="range" id="rentIncrementRange" min="0" max="10" step="0.5" value="5">
                </div>

                <div class="field">
                    <label>Loan Tenure (Months)</label>
                    <input id="loanTenure" type="text" value="240">
                </div>

                <div class="field">
                    <label>Lease Tenure (Months)</label>
                    <input id="leaseTenure" type="text" value="240">
                </div>

                <div class="field">
                    <label>Withholding (%)</label>
                    <input id="withholding" type="text" value="0">
                </div>

                <div class="field">
                    <label>Refund Delay (Months)</label>
                    <input id="refundDelay" type="text" value="0">
                </div>
            </div>
        </div>

        <!-- KEY METRICS PANEL -->
        <div class="card">
            <div class="card-title"> Key Financial Metrics</div>
            <div class="decision-panel">
                <div class="decision-metric">
                    <div class="metric-label">Monthly Savings</div>
                    <div id="mSave" class="metric-value">0</div>
                    <div class="metric-insight" id="mSaveInsight">Lease vs Buy monthly cost difference</div>
                </div>

                <div class="decision-metric">
                    <div class="metric-label">Total Lease Term Savings</div>
                    <div id="tSave" class="metric-value">0</div>
                    <div class="metric-insight" id="tSaveInsight">Cumulative savings over entire lease period</div>
                </div>

                <div class="decision-metric">
                    <div class="metric-label">Break-Even Point</div>
                    <div id="breakEven" class="metric-value">-</div>
                    <div class="metric-insight">Months until leasing becomes more economical</div>
                </div>

                <div class="decision-metric">
                    <div class="metric-label">Total Economic Cost (Buy)</div>
                    <div id="totalEconomic" class="metric-value">0</div>
                    <div class="metric-insight">All hidden costs of buying</div>
                </div>
            </div>
        </div>

        <!-- DECISION SCORE -->
        <div class="card">
            <div class="score-section">
                <h3 style="font-size: 18px; margin-bottom: 10px;">Lease vs Buy Decision Score</h3>
                <div class="score-gauge">
                    <div class="gauge-inner">
                        <span id="dial" style="color: var(--accent); font-size: 40px;">0</span>
                        <div class="score-label">Score</div>
                    </div>
                </div>
                <div id="scoreInterpretation" class="score-text">Analyzing parameters...</div>
                <div class="recommendations">
                    <div class="recommendation-title"> Key Recommendations</div>
                    <div id="recommendations"></div>
                </div>
            </div>
        </div>

        <!-- BI CHARTS - DECISION FOCUSED -->
        <div class="charts-grid">
            <!-- CHART 1: Cost Comparison -->
            <div class="chart-card">
                <div class="card-title"> Total Cost Comparison (Annual)</div>
                <div class="chart-container">
                    <canvas id="costComparisonChart"></canvas>
                </div>
                <div class="chart-insight">
                     Red = Buying costs (EMI + Maintenance + Interest). Blue = Leasing cost. The lower bar indicates the better choice financially.
                </div>
            </div>

            <!-- CHART 2: Monthly Cost Trajectory -->
            <div class="chart-card">
                <div class="card-title"> Monthly Cost Evolution</div>
                <div class="chart-container">
                    <canvas id="monthlyCostChart"></canvas>
                </div>
                <div class="chart-insight">
                     Red line shows increasing buy costs (EMI + maintenance). Blue line shows market rent escalation. Where they intersect is your break-even point.
                </div>
            </div>

            <!-- CHART 3: Cumulative Cost Break-Even -->
            <div class="chart-card">
                <div class="card-title"> Cumulative Cost Analysis (Break-Even)</div>
                <div class="chart-container">
                    <canvas id="cumulativeChart"></canvas>
                </div>
                <div class="chart-insight">
                     Shows total accumulated costs over time. The intersection point reveals when leasing becomes more economical. Crossing point = decision threshold.
                </div>
            </div>

            <!-- CHART 4: Cost Sensitivity Matrix -->
            <div class="chart-card">
                <div class="card-title"> Sensitivity Analysis: Risk vs Decision</div>
                <div class="chart-container">
                    <canvas id="sensitivityChart"></canvas>
                </div>
                <div class="chart-insight">
                     Tests your decision robustness. Shows how savings change with market volatility. Flat line = stable decision. Steep line = decision at risk.
                </div>
            </div>

            <!-- CHART 5: Cost Component Breakdown -->
            <div class="chart-card">
                <div class="card-title"> What's Driving Your Decision?</div>
                <div class="chart-container">
                    <canvas id="componentChart"></canvas>
                </div>
                <div class="chart-insight">
                     Pie chart showing which costs matter most in buying: interest burden, opportunity costs, maintenance, etc. Helps identify cost drivers.
                </div>
            </div>

            <!-- CHART 6: Economic Value Over Time -->
            <div class="chart-card">
                <div class="card-title"> Economic Advantage Timeline</div>
                <div class="chart-container">
                    <canvas id="valueChart"></canvas>
                </div>
                <div class="chart-insight">
                     Shows your cumulative economic advantage over the lease term. Positive = leasing is better. Negative = buying is better. Higher = stronger advantage.
                </div>
            </div>
        </div>

    </div>

    <script>

        /* ================= THEME TOGGLE ================= */
        function toggleTheme() {
            const isDark = !document.body.classList.contains('light');
            document.body.classList.toggle('light');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            updateThemeUI();
            updateAllCharts();
        }

        function updateThemeUI() {
            const isDark = !document.body.classList.contains('light');
            document.getElementById('theme-icon').textContent = isDark ? '' : '';
            document.getElementById('theme-text').textContent = isDark ? 'Dark' : 'Light';
        }

        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light');
            updateThemeUI();
        }

        /* ================= SCROLL REVEAL ================= */
        const observer = new IntersectionObserver(entries => {
            entries.forEach(e => {
                if (e.isIntersecting) e.target.classList.add('show');
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.card, .chart-card').forEach(el => observer.observe(el));

        /* ================= HELPERS ================= */
        const $ = id => document.getElementById(id);

        function cleanNumber(v) {
            return parseFloat((v || '').replace(/[,%\s,]/g, '')) || 0;
        }

        function num(id) {
            const val = cleanNumber($(id).value);
            return isNaN(val) ? 0 : val;
        }

        function formatINR(n) {
            n = Math.max(0, Number(n) || 0);
            return '' + Math.round(n).toLocaleString('en-IN');
        }

        /* ================= INPUT SYNC ================= */
        ['leaseAmount', 'loanAmount', 'loanRate', 'oppRate', 'riskPremium', 'marketRent', 'maintenance', 'rentIncrement']
            .forEach(id => {
                const input = $(id);
                const range = $(id + 'Range');
                if (!range) return;

                range.addEventListener('input', () => {
                    input.value = range.value;
                    calculate();
                });

                input.addEventListener('input', () => {
                    const clean = cleanNumber(input.value);
                    range.value = clean;
                    calculate();
                });
            });

        /* ================= CHARTS ================= */
        let costComparisonChart, monthlyCostChart, cumulativeChart, sensitivityChart, componentChart, valueChart;

        function updateAllCharts() {
            [costComparisonChart, monthlyCostChart, cumulativeChart, sensitivityChart, componentChart, valueChart]
                .forEach(chart => { if (chart) chart.update(); });
        }

        /* ================= EMI CALCULATOR ================= */
        function emi(P, r, n) {
            if (r === 0) return P / n;
            return P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
        }

        /* ================= MAIN CALCULATION ================= */
        function calculate() {
            try {
                const LEASE_AMOUNT = num('leaseAmount');
                const LOAN_AMOUNT = num('loanAmount');
                const OWN_FUNDS = Math.max(0, LEASE_AMOUNT - LOAN_AMOUNT);

                const LOAN_INTEREST_RATE = (num('loanRate') / 100) / 12;
                const LOAN_TENURE = num('loanTenure');
                const LEASE_TENURE = num('leaseTenure');

                const WITHHOLDING = num('withholding') / 100;
                const REFUND_DELAY = num('refundDelay');

                const MAINTENANCE = num('maintenance');
                const MARKET_RENT = num('marketRent');

                const OPP_RATE = (num('oppRate') / 100) / 12;
                const RISK_PREMIUM = num('riskPremium') / 100;
                const RENT_INCREMENT = num('rentIncrement') / 100;

                if (LEASE_TENURE <= 0 || LOAN_TENURE <= 0 || MARKET_RENT <= 0) return;

                // CALCULATIONS
                const EMI = emi(LOAN_AMOUNT, LOAN_INTEREST_RATE, LOAN_TENURE);
                const totalInterest = EMI * LOAN_TENURE - LOAN_AMOUNT;
                const monthlyLeaseCost = EMI + MAINTENANCE;

                const refund = LEASE_AMOUNT * (1 - WITHHOLDING);
                const withholdingLoss = LEASE_AMOUNT * WITHHOLDING;

                const ownOpp = OWN_FUNDS * (Math.pow(1 + OPP_RATE, LEASE_TENURE) - 1);

                let emiOpp = 0;
                for (let m = 1; m <= LEASE_TENURE; m++) {
                    const yearIndex = Math.floor((m - 1) / 12);
                    const adjustedRent = MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yearIndex);
                    const extra = monthlyLeaseCost - adjustedRent;
                    if (extra > 0) {
                        emiOpp += extra * (Math.pow(1 + OPP_RATE, LEASE_TENURE - m + 1) - 1);
                    }
                }

                const delayCost = refund * OPP_RATE * REFUND_DELAY;
                const capitalLoss = totalInterest + withholdingLoss;
                const totalEconomic = capitalLoss + ownOpp + emiOpp + delayCost;

                const riskRent = (totalEconomic / LEASE_TENURE) * (1 + RISK_PREMIUM);
                const monthlySavings = MARKET_RENT - riskRent;
                const yearlySavings = monthlySavings * 12;
                const termSavings = monthlySavings * LEASE_TENURE;

                // SCORE
                let score = MARKET_RENT > 0 ? (monthlySavings / MARKET_RENT) * 100 : 0;
                score = Math.max(0, Math.min(100, score));

                let color = '#f1c40f';
                let recommendation = [];

                if (score < 5) {
                    color = '#ff4d4d';
                    recommendation = [
                        ' BUYING is the better option',
                        '• Savings from leasing are negligible',
                        '• Own the asset for better value'
                    ];
                } else if (score < 25) {
                    color = '#ff9f43';
                    recommendation = [
                        ' BUYING is slightly better',
                        '• Small savings from leasing',
                        '• Consider flexibility needs'
                    ];
                } else if (score < 50) {
                    color = '#f1c40f';
                    recommendation = [
                        ' MARGINAL difference',
                        '• Consider non-financial factors',
                        '• Flexibility might favor leasing'
                    ];
                } else if (score < 75) {
                    color = '#2ecc71';
                    recommendation = [
                        ' LEASING is recommended',
                        '• Significant savings: ' + formatINR(termSavings),
                        '• Better cash flow and flexibility'
                    ];
                } else {
                    color = '#1abc9c';
                    recommendation = [
                        ' STRONG lease advantage',
                        '• Major savings: ' + formatINR(termSavings),
                        '• Highly recommended to lease'
                    ];
                }

                // UPDATE UI
                $('gauge').style.background = `conic-gradient(${color} ${score * 3.6}deg, #1a2a38 ${score * 3.6}deg)`;
                $('dial').style.color = color;
                $('dial').innerText = Math.round(score);

                $('scoreInterpretation').innerHTML = 
                    (score < 5 ? '' : score < 25 ? '' : score < 50 ? '' : score < 75 ? '' : '') + 
                    ' <strong>Decision Score: ' + Math.round(score) + '/100</strong><br>' +
                    (score < 25 ? 'Buying is more economical' : 'Leasing is more economical');

                $('recommendations').innerHTML = recommendation.map(r => 
                    '<div class="recommendation-item">' + r + '</div>'
                ).join('');

                $('mSave').innerText = formatINR(monthlySavings);
                $('mSaveInsight').innerText = monthlySavings > 0 ? 
                    ' Leasing saves monthly' : ' Buying is cheaper';

                $('tSave').innerText = formatINR(termSavings);
                $('tSaveInsight').innerText = termSavings > 0 ? 
                    ' Total lease advantage' : ' Total buy advantage';

                $('totalEconomic').innerText = formatINR(totalEconomic);

                // BREAK-EVEN
                let breakEvenMonths = Math.max(0, Math.ceil(-LOAN_AMOUNT / (monthlySavings * (1 - monthlySavings / MARKET_RENT))));
                if (monthlySavings <= 0) {
                    breakEvenMonths = LEASE_TENURE;
                    $('breakEven').innerText = 'Never';
                } else {
                    $('breakEven').innerText = breakEvenMonths + ' mo';
                }

                // CHART DATA
                const buyingCost = EMI * 12;
                const maintenanceCost = MAINTENANCE * 12;
                const leasingCost = riskRent * 12;

                // CHART 1: Cost Comparison
                if (!costComparisonChart) {
                    costComparisonChart = new Chart($('costComparisonChart'), {
                        type: 'bar',
                        data: {
                            labels: ['Annual Cost'],
                            datasets: [
                                {
                                    label: 'Buying (EMI + Maintenance + Interest)',
                                    data: [buyingCost + maintenanceCost + totalInterest / 12],
                                    backgroundColor: '#ff4d4d',
                                    borderRadius: 8,
                                },
                                {
                                    label: 'Leasing (Effective Rent)',
                                    data: [leasingCost],
                                    backgroundColor: '#4db3ff',
                                    borderRadius: 8,
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            plugins: { legend: { position: 'top' } },
                            scales: {
                                x: {
                                    ticks: { callback: v => formatINR(v) },
                                    grid: { color: 'rgba(77, 179, 255, 0.1)' }
                                }
                            }
                        }
                    });
                } else {
                    costComparisonChart.data.datasets[0].data = [buyingCost + maintenanceCost + totalInterest / 12];
                    costComparisonChart.data.datasets[1].data = [leasingCost];
                    costComparisonChart.update();
                }

                // CHART 2: Monthly Cost Evolution
                let monthlyBuyCosts = [], monthlyLeaseCosts = [], months = [];
                for (let m = 1; m <= Math.min(LEASE_TENURE, 60); m++) {
                    months.push('M' + m);
                    monthlyBuyCosts.push(monthlyLeaseCost);
                    let yearIndex = Math.floor((m - 1) / 12);
                    monthlyLeaseCosts.push(MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yearIndex));
                }

                if (!monthlyCostChart) {
                    monthlyCostChart = new Chart($('monthlyCostChart'), {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'Buy Cost',
                                    data: monthlyBuyCosts,
                                    borderColor: '#ff4d4d',
                                    backgroundColor: 'rgba(255, 77, 77, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.4,
                                },
                                {
                                    label: 'Lease Cost',
                                    data: monthlyLeaseCosts,
                                    borderColor: '#4db3ff',
                                    backgroundColor: 'rgba(77, 179, 255, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.4,
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'top' } },
                            scales: {
                                y: {
                                    ticks: { callback: v => formatINR(v) },
                                    grid: { color: 'rgba(77, 179, 255, 0.1)' }
                                }
                            }
                        }
                    });
                } else {
                    monthlyCostChart.data.labels = months;
                    monthlyCostChart.data.datasets[0].data = monthlyBuyCosts;
                    monthlyCostChart.data.datasets[1].data = monthlyLeaseCosts;
                    monthlyCostChart.update();
                }

                // CHART 3: Cumulative Break-Even
                let cumulativeBuy = 0, cumulativeLease = 0;
                let cumulativeBuyData = [], cumulativeLeaseData = [], cumulativeMonths = [];
                for (let m = 1; m <= Math.min(LEASE_TENURE, 120); m++) {
                    cumulativeBuy += monthlyLeaseCost;
                    let yearIndex = Math.floor((m - 1) / 12);
                    cumulativeLease += MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yearIndex);
                    cumulativeBuyData.push(cumulativeBuy);
                    cumulativeLeaseData.push(cumulativeLease);
                    cumulativeMonths.push('M' + m);
                }

                if (!cumulativeChart) {
                    cumulativeChart = new Chart($('cumulativeChart'), {
                        type: 'line',
                        data: {
                            labels: cumulativeMonths,
                            datasets: [
                                {
                                    label: 'Cumulative Buy Cost',
                                    data: cumulativeBuyData,
                                    borderColor: '#ff4d4d',
                                    backgroundColor: 'rgba(255, 77, 77, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.3,
                                },
                                {
                                    label: 'Cumulative Lease Cost',
                                    data: cumulativeLeaseData,
                                    borderColor: '#2ecc71',
                                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.3,
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'top' } },
                            scales: {
                                y: {
                                    ticks: { callback: v => formatINR(v) },
                                    grid: { color: 'rgba(77, 179, 255, 0.1)' }
                                }
                            }
                        }
                    });
                } else {
                    cumulativeChart.data.labels = cumulativeMonths;
                    cumulativeChart.data.datasets[0].data = cumulativeBuyData;
                    cumulativeChart.data.datasets[1].data = cumulativeLeaseData;
                    cumulativeChart.update();
                }

                // CHART 4: Sensitivity
                let riskAxis = [], savingsAxis = [];
                for (let r = -20; r <= 20; r += 2) {
                    let scenarioRiskRent = riskRent * (1 + r / 100);
                    riskAxis.push(r + '%');
                    savingsAxis.push(MARKET_RENT - scenarioRiskRent);
                }

                if (!sensitivityChart) {
                    sensitivityChart = new Chart($('sensitivityChart'), {
                        type: 'line',
                        data: {
                            labels: riskAxis,
                            datasets: [{
                                label: 'Monthly Savings Under Risk',
                                data: savingsAxis,
                                borderColor: color,
                                backgroundColor: color + '20',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 4,
                                pointBackgroundColor: color,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'top' } },
                            scales: {
                                y: {
                                    ticks: { callback: v => formatINR(v) },
                                    grid: { color: 'rgba(77, 179, 255, 0.1)' }
                                }
                            }
                        }
                    });
                } else {
                    sensitivityChart.data.labels = riskAxis;
                    sensitivityChart.data.datasets[0].data = savingsAxis;
                    sensitivityChart.data.datasets[0].borderColor = color;
                    sensitivityChart.data.datasets[0].backgroundColor = color + '20';
                    sensitivityChart.update();
                }

                // CHART 5: Component Breakdown
                if (!componentChart) {
                    componentChart = new Chart($('componentChart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Interest Cost', 'Opportunity Cost', 'Maintenance', 'Withholding Loss'],
                            datasets: [{
                                data: [totalInterest, ownOpp, MAINTENANCE * LEASE_TENURE, withholdingLoss],
                                backgroundColor: ['#ff4d4d', '#f1c40f', '#3498db', '#9b59b6'],
                                borderRadius: 6,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'right' } }
                        }
                    });
                } else {
                    componentChart.data.datasets[0].data = [totalInterest, ownOpp, MAINTENANCE * LEASE_TENURE, withholdingLoss];
                    componentChart.update();
                }

                // CHART 6: Economic Value Over Time
                let valueLabels = [], valueData = [];
                let cumulativeSavings = 0;
                for (let m = 1; m <= Math.min(LEASE_TENURE, 120); m++) {
                    cumulativeSavings += (MARKET_RENT * Math.pow(1 + RENT_INCREMENT, Math.floor((m-1)/12)) - monthlyLeaseCost);
                    valueLabels.push('M' + m);
                    valueData.push(cumulativeSavings);
                }

                if (!valueChart) {
                    valueChart = new Chart($('valueChart'), {
                        type: 'line',
                        data: {
                            labels: valueLabels,
                            datasets: [{
                                label: 'Cumulative Economic Value of Leasing',
                                data: valueData,
                                borderColor: color,
                                backgroundColor: color + '20',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 6,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'top' } },
                            scales: {
                                y: {
                                    ticks: { callback: v => formatINR(v) },
                                    grid: { color: 'rgba(77, 179, 255, 0.1)' }
                                }
                            }
                        }
                    });
                } else {
                    valueChart.data.labels = valueLabels;
                    valueChart.data.datasets[0].data = valueData;
                    valueChart.data.datasets[0].borderColor = color;
                    valueChart.data.datasets[0].backgroundColor = color + '20';
                    valueChart.update();
                }

            } catch (error) {
                console.error('Calculation error:', error);
            }
        }

        /* ================= EVENT LISTENERS ================= */
        document.querySelectorAll('input').forEach(el => {
            el.addEventListener('input', () => {
                const timer = setTimeout(calculate, 300);
                el.addEventListener('input', () => clearTimeout(timer), { once: true });
            });
        });

        window.addEventListener('load', calculate);
        calculate();

    </script>
</body>

</html>