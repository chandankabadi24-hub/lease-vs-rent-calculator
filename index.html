<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lease vs Rent - Advanced BI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        /* ============================= */
        /* ===== ELITE FINTECH BI UI ==== */
        /* ============================= */

        :root {
            --bg: #060d15;
            --card: #0e1a27;
            --text: #eaf2f9;
            --accent: #4db3ff;
            --muted: #94a8bd;
            --green: #2ecc71;
            --amber: #f1c40f;
            --red: #ff4d4d;
            --purple: #9b59b6;
            --border: #1a2a38;
            --cyan: #00d4ff;
            --orange: #ff8c3a;
        }

        body.light {
            --bg: #f4f7fb;
            --card: #ffffff;
            --text: #0b1622;
            --accent: #1f4e79;
            --muted: #5c6c7a;
            --border: #e0e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: 0.35s ease;
            scroll-behavior: smooth;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            gap: 24px;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
        }

        .logo {
            font-size: 26px;
            font-weight: 900;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .toggle {
            background: var(--accent);
            color: #060d15;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(77, 179, 255, 0.25);
        }

        .toggle:active {
            transform: translateY(0);
        }

        /* ===== CARDS ===== */
        .card, .chartCard {
            background: linear-gradient(135deg, var(--card), rgba(30, 40, 50, 0.5));
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card.show, .chartCard.show {
            opacity: 1;
            transform: translateY(0);
        }

        .card:hover, .chartCard:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.18);
            border-color: var(--accent);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 18px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.3px;
        }

        .card-icon {
            font-size: 22px;
            display: inline-flex;
        }

        /* ===== GRID LAYOUT ===== */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
            }
        }

        /* ===== FORM FIELDS ===== */
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field-wrapper {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        label {
            font-size: 11px;
            color: var(--muted);
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .label-value {
            font-size: 12px;
            color: var(--accent);
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        input[type="text"],
        input[type="number"] {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1.5px solid var(--border);
            background: rgba(10, 24, 38, 0.5);
            color: var(--text);
            font-weight: 600;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        body.light input[type="text"],
        body.light input[type="number"] {
            background: rgba(240, 245, 250, 0.8);
        }

        input[type="text"]:hover,
        input[type="number"]:hover {
            border-color: var(--border);
            background: var(--card);
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--card);
            box-shadow: 0 0 0 3px rgba(77, 179, 255, 0.1);
        }

        /* ===== SLIDERS - ENHANCED ===== */
        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(to right, var(--border), var(--border));
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: grab;
            padding: 8px 0;
            pointer-events: none;
            transition: background 0.2s ease;
        }

        input[type="range"]:active {
            cursor: grabbing;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: grab;
            pointer-events: auto;
            box-shadow: 0 2px 8px rgba(77, 179, 255, 0.3);
            transition: all 0.2s ease;
            border: 2px solid var(--card);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            box-shadow: 0 4px 12px rgba(77, 179, 255, 0.5);
            transform: scale(1.1);
        }

        input[type="range"]::-webkit-slider-thumb:active {
            box-shadow: 0 6px 16px rgba(77, 179, 255, 0.6);
            transform: scale(1.15);
        }

        input[type="range"]:focus {
            outline: none;
        }

        input[type="range"]:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 3px rgba(77, 179, 255, 0.2), 0 4px 12px rgba(77, 179, 255, 0.5);
        }

        input[type="range"]::-moz-range-track {
            background: transparent;
            border: none;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: grab;
            border: 2px solid var(--card);
            box-shadow: 0 2px 8px rgba(77, 179, 255, 0.3);
            transition: all 0.2s ease;
        }

        input[type="range"]::-moz-range-thumb:hover {
            box-shadow: 0 4px 12px rgba(77, 179, 255, 0.5);
            transform: scale(1.1);
        }

        input[type="range"]::-moz-range-thumb:active {
            box-shadow: 0 6px 16px rgba(77, 179, 255, 0.6);
            transform: scale(1.15);
            cursor: grabbing;
        }

        input[type="range"]:focus::-moz-range-thumb {
            box-shadow: 0 0 0 3px rgba(77, 179, 255, 0.2), 0 4px 12px rgba(77, 179, 255, 0.5);
        }

        .micro {
            font-size: 11px;
            color: var(--muted);
            font-weight: 500;
            min-height: 14px;
            transition: 0.25s;
        }

        /* ===== DECISION GAUGE ===== */
        .gauge-section {
            text-align: center;
            padding: 16px 0;
        }

        .gaugeWrap {
            display: flex;
            justify-content: center;
            margin: 16px 0;
        }

        .gauge {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 32px rgba(77, 179, 255, 0.2);
            position: relative;
            background: conic-gradient(#4db3ff 0deg, #9b59b6 360deg);
        }

        .gauge::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            filter: blur(16px);
            opacity: 0.2;
            z-index: -1;
        }

        .gaugeInner {
            width: 185px;
            height: 185px;
            border-radius: 50%;
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 44px;
            font-weight: 900;
            box-shadow: inset 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .gauge-label {
            font-size: 11px;
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-top: 6px;
        }

        .gauge-interpretation {
            font-size: 14px;
            margin-top: 18px;
            color: var(--muted);
            line-height: 1.6;
            min-height: 48px;
            font-weight: 500;
        }

        /* ===== METRICS ===== */
        .metricsBox {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .metric-card {
            background: rgba(77, 179, 255, 0.08);
            padding: 14px;
            border-radius: 10px;
            border: 1px solid rgba(77, 179, 255, 0.15);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .metric-card:hover {
            background: rgba(77, 179, 255, 0.12);
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .metric-label {
            font-size: 10px;
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 22px;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: -0.5px;
            font-family: 'Courier New', monospace;
        }

        /* ===== CHARTS ===== */
        .chartCard {
            position: relative;
        }

        .chart-container {
            position: relative;
            height: 380px;
            margin-top: 12px;
            animation: fadeInChart 0.8s ease-out;
        }

        @keyframes fadeInChart {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        canvas {
            max-height: 100% !important;
        }

        .chart-description {
            font-size: 12px;
            color: var(--muted);
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            line-height: 1.6;
        }

        /* ===== CHARTS GRID ===== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(580px, 1fr));
            gap: 20px;
        }

        .chart-full {
            grid-column: 1 / -1;
        }

        @media (max-width: 1400px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===== COMPARATIVE TABLE ===== */
        .comparison-table {
            width: 100%;
            margin-top: 16px;
            border-collapse: collapse;
        }

        .comparison-table th {
            background: rgba(77, 179, 255, 0.08);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
            font-size: 11px;
            text-transform: uppercase;
            color: var(--accent);
            letter-spacing: 0.2px;
        }

        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 500;
        }

        .comparison-table tr:hover {
            background: rgba(77, 179, 255, 0.04);
        }

        .metric-positive {
            color: var(--green);
            font-weight: 700;
        }

        .metric-negative {
            color: var(--red);
            font-weight: 700;
        }

        /* ===== SECTION HEADERS ===== */
        .section-header {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 14px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header-icon {
            font-size: 16px;
        }

        .divider {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .container {
                gap: 16px;
            }

            .card, .chartCard {
                padding: 16px;
            }

            .card-title {
                font-size: 16px;
                margin-bottom: 14px;
            }

            .chart-container {
                height: 280px;
            }

            .gauge {
                width: 180px;
                height: 180px;
            }

            .gaugeInner {
                width: 145px;
                height: 145px;
                font-size: 36px;
            }

            .header {
                flex-direction: column;
                gap: 12px;
                padding: 12px 0;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .metricsBox {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ===== ANIMATIONS ===== */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .show {
            animation: slideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards !important;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(77, 179, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 40px rgba(77, 179, 255, 0.5);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* ===== FOCUS VISIBLE - Keyboard Navigation ===== */
        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        button:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <div class="header">
        <div class="logo">üí∞ Aladdin Finance BI</div>
        <button class="toggle" onclick="toggleTheme()" aria-label="Toggle between dark and light theme">
            <span id="theme-icon">üåô</span> <span id="theme-text">Dark</span>
        </button>
    </div>

    <div class="container">

        <!-- INPUT PANEL -->
        <div class="card">
            <div class="card-title"><span class="card-icon">‚öôÔ∏è</span>Financial Parameters</div>
            
            <!-- Two-Column Layout for Lease and Rent Components -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 12px;">
                
                <!-- LEASE COMPONENTS -->
                <div>
                    <div class="section-header">
                        <span class="section-header-icon">üìã</span>
                        Lease Components
                    </div>
                    <div class="grid">
                        <div class="field">
                            <div class="field-wrapper">
                                <label>
                                    Lease Amount (‚Çπ)
                                    <span class="label-value" id="leaseAmountLabel">‚Çπ2,000,000</span>
                                </label>
                                <div class="input-group">
                                    <input id="leaseAmount" type="text" value="2000000" aria-label="Lease Amount">
                                    <input type="range" id="leaseAmountRange" min="100000" max="5000000" step="50000" value="2000000" aria-label="Lease Amount slider">
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <div class="field-wrapper">
                                <label>
                                    Loan Amount (‚Çπ)
                                    <span class="label-value" id="loanAmountLabel">‚Çπ1,500,000</span>
                                </label>
                                <div class="input-group">
                                    <input id="loanAmount" type="text" value="1500000" aria-label="Loan Amount">
                                    <input type="range" id="loanAmountRange" min="0" max="5000000" step="50000" value="1500000" aria-label="Loan Amount slider">
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <div class="field-wrapper">
                                <label>
                                    Loan Interest Rate (%)
                                    <span class="label-value" id="loanRateLabel">8.5%</span>
                                </label>
                                <div class="input-group">
                                    <input id="loanRate" type="text" value="8.5" aria-label="Loan Interest Rate">
                                    <input type="range" id="loanRateRange" min="1" max="20" step="0.1" value="8.5" aria-label="Loan Interest Rate slider">
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <div class="field-wrapper">
                                <label>
                                    Monthly Maintenance (‚Çπ)
                                    <span class="label-value" id="maintenanceLabel">‚Çπ5,000</span>
                                </label>
                                <div class="input-group">
                                    <input id="maintenance" type="text" value="5000" aria-label="Monthly Maintenance">
                                    <input type="range" id="maintenanceRange" min="0" max="20000" step="500" value="5000" aria-label="Monthly Maintenance slider">
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <label for="withholding">Lease Withholding (%)</label>
                            <input id="withholding" type="text" value="0" aria-label="Lease Withholding Percentage">
                        </div>

                        <div class="field">
                            <label for="refundDelay">Lease Refund Delay (Months)</label>
                            <input id="refundDelay" type="text" value="0" aria-label="Lease Refund Delay in Months">
                        </div>
                    </div>
                </div>

                <!-- RENT COMPONENTS -->
                <div>
                    <div class="section-header">
                        <span class="section-header-icon">üè†</span>
                        Rent Components
                    </div>
                    <div class="grid">
                        <div class="field">
                            <div class="field-wrapper">
                                <label>
                                    Market Rent (‚Çπ)
                                    <span class="label-value" id="marketRentLabel">‚Çπ45,000</span>
                                </label>
                                <div class="input-group">
                                    <input id="marketRent" type="text" value="45000" aria-label="Market Rent">
                                    <input type="range" id="marketRentRange" min="5000" max="200000" step="1000" value="45000" aria-label="Market Rent slider">
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <div class="field-wrapper">
                                <label>
                                    Rent Deposit (‚Çπ)
                                    <span class="label-value" id="rentDepositLabel">‚Çπ0</span>
                                </label>
                                <div class="input-group">
                                    <input id="rentDeposit" type="text" value="0" aria-label="Rent Deposit">
                                    <input type="range" id="rentDepositRange" min="0" max="500000" step="10000" value="0" aria-label="Rent Deposit slider">
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <div class="field-wrapper">
                                <label>
                                    Deposit Refund Delay (Months)
                                    <span class="label-value" id="depositRefundDelayLabel">0</span>
                                </label>
                                <div class="input-group">
                                    <input id="depositRefundDelay" type="text" value="0" aria-label="Deposit Refund Delay">
                                    <input type="range" id="depositRefundDelayRange" min="0" max="12" step="1" value="0" aria-label="Deposit Refund Delay slider">
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <div class="field-wrapper">
                                <label>
                                    Rent Increment (%)
                                    <span class="label-value" id="rentIncrementLabel">5%</span>
                                </label>
                                <div class="input-group">
                                    <input id="rentIncrement" type="text" value="5" aria-label="Rent Increment Percentage">
                                    <input type="range" id="rentIncrementRange" min="0" max="10" step="0.5" value="5" aria-label="Rent Increment slider">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Common Parameters Section -->
            <div class="divider"></div>
            <div>
                <div class="section-header">
                    <span class="section-header-icon">‚öñÔ∏è</span>
                    Common Parameters
                </div>
                <div class="grid">
                    <div class="field">
                        <div class="field-wrapper">
                            <label>
                                Lease Tenure (Months)
                                <span class="label-value" id="leaseTenureLabel">240</span>
                            </label>
                            <div class="input-group">
                                <input id="leaseTenure" type="text" value="240" aria-label="Lease Tenure in Months">
                                <input type="range" id="leaseTenureRange" min="12" max="360" step="12" value="240" aria-label="Lease Tenure slider">
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <div class="field-wrapper">
                            <label>
                                Loan Tenure (Months)
                                <span class="label-value" id="loanTenureLabel">240</span>
                            </label>
                            <div class="input-group">
                                <input id="loanTenure" type="text" value="240" aria-label="Loan Tenure in Months">
                                <input type="range" id="loanTenureRange" min="12" max="360" step="12" value="240" aria-label="Loan Tenure slider">
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <div class="field-wrapper">
                            <label>
                                Opportunity Cost (%)
                                <span class="label-value" id="oppRateLabel">12%</span>
                            </label>
                            <div class="input-group">
                                <input id="oppRate" type="text" value="12" aria-label="Opportunity Cost Rate">
                                <input type="range" id="oppRateRange" min="1" max="20" step="0.1" value="12" aria-label="Opportunity Cost slider">
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <div class="field-wrapper">
                            <label>
                                Risk Premium (%)
                                <span class="label-value" id="riskPremiumLabel">3%</span>
                            </label>
                            <div class="input-group">
                                <input id="riskPremium" type="text" value="3" aria-label="Risk Premium Rate">
                                <input type="range" id="riskPremiumRange" min="0" max="20" step="0.1" value="3" aria-label="Risk Premium slider">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DECISION GAUGE & KPIs -->
        <div class="card">
            <div class="card-title"><span class="card-icon">üìä</span>Decision Intelligence Score</div>
            <div class="gauge-section">
                <div class="gaugeWrap">
                    <div id="gauge" class="gauge" role="img" aria-label="Decision score gauge">
                        <div class="gaugeInner">
                            <span id="dial">0</span>
                            <div class="gauge-label">Score</div>
                        </div>
                    </div>
                </div>
                <div class="gauge-interpretation" id="interpretation">Analyzing parameters...</div>
            </div>

            <div class="metricsBox">
                <div class="metric-card">
                    <div class="metric-label">Monthly EMI</div>
                    <div id="mEMI" class="metric-value">‚Çπ0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Maintenance</div>
                    <div id="mMaintenance" class="metric-value">‚Çπ0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Monthly Gain</div>
                    <div id="mSave" class="metric-value">‚Çπ0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Annual Gain</div>
                    <div id="ySave" class="metric-value">‚Çπ0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Term Gain</div>
                    <div id="tSave" class="metric-value">‚Çπ0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Confidence</div>
                    <div id="confidence" class="metric-value">0%</div>
                </div>
            </div>
        </div>

        <!-- CHARTS SECTION -->
        <div class="charts-grid">

            <!-- 1. Total Cost of Ownership Waterfall -->
            <div class="chartCard">
                <div class="card-title"><span class="card-icon">üíæ</span>Total Economic Cost Drivers</div>
                <div class="chart-container">
                    <canvas id="tcoChart"></canvas>
                </div>
                <div class="chart-description">
                    All cost components when leasing. Shows interest, opportunity costs, and maintenance.
                </div>
            </div>

            <!-- 2. Monthly Cost Comparison Waterfall -->
            <div class="chartCard">
                <div class="card-title"><span class="card-icon">üí∞</span>Monthly Cost Comparison</div>
                <div class="chart-container">
                    <canvas id="monthlyCostChart"></canvas>
                </div>
                <div class="chart-description">
                    Direct comparison of monthly outflows: Risk-Adjusted Lease Cost vs. Market Rent.
                </div>
            </div>

            <!-- 3. 10-Year Cumulative Impact (Full Width) -->
            <div class="chartCard chart-full">
                <div class="card-title"><span class="card-icon">üìà</span>Cumulative Cost Impact Over Time</div>
                <div class="chart-container">
                    <canvas id="cumulativeImpactChart"></canvas>
                </div>
                <div class="chart-description">
                    Total accumulated costs: Lease vs. Market Rent. The spread between lines is your financial advantage.
                </div>
            </div>

            <!-- 4. Sensitivity Analysis Heatmap -->
            <div class="chartCard">
                <div class="card-title"><span class="card-icon">üî•</span>Decision Robustness Matrix</div>
                <div class="chart-container">
                    <canvas id="sensitivityChart"></canvas>
                </div>
                <div class="chart-description">
                    How does the outcome change with interest rate and rent growth variations? Red = Lease advantage.
                </div>
            </div>

            <!-- 5. Cost Composition Pie -->
            <div class="chartCard">
                <div class="card-title"><span class="card-icon">ü•ß</span>Economic Cost Distribution</div>
                <div class="chart-container">
                    <canvas id="costCompositionChart"></canvas>
                </div>
                <div class="chart-description">
                    Which cost categories dominate: Interest, Opportunity costs, Maintenance, etc.
                </div>
            </div>

            <!-- 6. Rent Escalation Forecast -->
            <div class="chartCard">
                <div class="card-title"><span class="card-icon">üìä</span>Rent Growth vs Fixed Lease</div>
                <div class="chart-container">
                    <canvas id="rentProjectionChart"></canvas>
                </div>
                <div class="chart-description">
                    Market rent escalation vs. fixed lease economics. Shows cumulative rent burden over time.
                </div>
            </div>

        </div>

        <!-- COMPARISON TABLE -->
        <div class="card">
            <div class="card-title"><span class="card-icon">üìã</span>Financial Summary</div>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Lease (Economic Cost)</th>
                        <th>Market Rent</th>
                        <th>Advantage</th>
                    </tr>
                </thead>
                <tbody id="comparisonBody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

    </div>

    <script>

        /* ================= THEME ================= */
        function toggleTheme() {
            const isDark = !document.body.classList.contains('light');
            document.body.classList.toggle('light');
            
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            updateThemeUI();
            
            // Redraw charts with new colors
            setTimeout(() => {
                if (tcoChart) tcoChart.update();
                if (monthlyCostChart) monthlyCostChart.update();
                if (cumulativeImpactChart) cumulativeImpactChart.update();
                if (sensitivityChart) sensitivityChart.update();
                if (costCompositionChart) costCompositionChart.update();
                if (rentProjectionChart) rentProjectionChart.update();
            }, 100);
        }

        function updateThemeUI() {
            const isDark = !document.body.classList.contains('light');
            document.getElementById('theme-icon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('theme-text').textContent = isDark ? 'Dark' : 'Light';
        }

        // Load saved theme
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light');
            updateThemeUI();
        }

        /* ================= SCROLL REVEAL ================= */
        const observer = new IntersectionObserver(entries => {
            entries.forEach(e => {
                if (e.isIntersecting) {
                    e.target.classList.add('show');
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.card, .chartCard').forEach(el => observer.observe(el));

        /* ================= HELPERS ================= */
        const $ = id => document.getElementById(id);

        function cleanNumber(v) {
            return parseFloat((v || '').replace(/[,%\s,‚Çπ]/g, '')) || 0;
        }

        function num(id) {
            const val = cleanNumber($(id).value);
            return isNaN(val) ? 0 : val;
        }

        function formatINR(n) {
            n = Math.max(0, Number(n) || 0);
            return '‚Çπ' + Math.round(n).toLocaleString('en-IN');
        }

        function formatPercent(n) {
            n = Number(n) || 0;
            return Number(n).toLocaleString('en-IN', { maximumFractionDigits: 2 }) + '%';
        }

        function getChartColors() {
            const isDark = !document.body.classList.contains('light');
            return {
                text: isDark ? '#eaf2f9' : '#0b1622',
                muted: isDark ? '#94a8bd' : '#5c6c7a',
                border: isDark ? '#1a2a38' : '#e0e8f0',
                primary: '#4db3ff',
                secondary: '#9b59b6',
                success: '#2ecc71',
                danger: '#ff4d4d',
                warning: '#f1c40f',
                cyan: '#00d4ff',
                orange: '#ff8c3a'
            };
        }

        /* ================= INPUT SYNC WITH LABELS ================= */
        const syncInputs = [
            { id: 'leaseAmount', label: 'leaseAmountLabel', format: 'inr' },
            { id: 'loanAmount', label: 'loanAmountLabel', format: 'inr' },
            { id: 'loanRate', label: 'loanRateLabel', format: 'percent' },
            { id: 'maintenance', label: 'maintenanceLabel', format: 'inr' },
            { id: 'marketRent', label: 'marketRentLabel', format: 'inr' },
            { id: 'rentDeposit', label: 'rentDepositLabel', format: 'inr' },
            { id: 'depositRefundDelay', label: 'depositRefundDelayLabel', format: 'plain' },
            { id: 'rentIncrement', label: 'rentIncrementLabel', format: 'percent' },
            { id: 'leaseTenure', label: 'leaseTenureLabel', format: 'plain' },
            { id: 'loanTenure', label: 'loanTenureLabel', format: 'plain' },
            { id: 'oppRate', label: 'oppRateLabel', format: 'percent' },
            { id: 'riskPremium', label: 'riskPremiumLabel', format: 'percent' }
        ];

        syncInputs.forEach(({ id, label, format }) => {
            const input = $(id);
            const range = $(id + 'Range');
            const labelEl = label ? $(label) : null;

            if (!range) return;

            const updateLabel = () => {
                if (!labelEl) return;
                const val = cleanNumber(input.value);
                if (format === 'inr') labelEl.innerText = formatINR(val);
                else if (format === 'percent') labelEl.innerText = formatPercent(val);
                else labelEl.innerText = val;
            };

            range.addEventListener('input', () => {
                input.value = range.value;
                updateLabel();
                calculate();
            });

            input.addEventListener('input', () => {
                const clean = cleanNumber(input.value);
                range.value = clean;
                updateLabel();
                calculate();
            });
        });

        /* ================= EMI CALCULATOR ================= */
        function emi(P, r, n) {
            if (r === 0) return P / n;
            return P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
        }

        /* ================= CHARTS ================= */
        let tcoChart, monthlyCostChart, cumulativeImpactChart, sensitivityChart, costCompositionChart, rentProjectionChart;

        function initCharts(data) {
            const colors = getChartColors();

            // 1. TCO CHART (Horizontal Bar - Waterfall Style)
            if (!tcoChart) {
                tcoChart = new Chart($('tcoChart'), {
                    type: 'bar',
                    data: {
                        labels: data.tco.labels,
                        datasets: [{
                            label: 'Economic Cost',
                            data: data.tco.values,
                            backgroundColor: [
                                'rgba(255, 77, 77, 0.8)',
                                'rgba(155, 89, 182, 0.8)',
                                'rgba(241, 196, 15, 0.8)',
                                'rgba(77, 179, 255, 0.8)',
                                'rgba(255, 140, 58, 0.8)',
                                'rgba(46, 204, 113, 0.8)'
                            ],
                            borderRadius: 8,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'right',
                                color: colors.text,
                                font: { weight: 'bold', size: 11 },
                                formatter: v => formatINR(v)
                            }
                        },
                        scales: {
                            x: {
                                ticks: { callback: v => formatINR(v), color: colors.muted },
                                grid: { color: colors.border }
                            },
                            y: {
                                ticks: { color: colors.muted },
                                grid: { display: false }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } else {
                tcoChart.data.labels = data.tco.labels;
                tcoChart.data.datasets[0].data = data.tco.values;
                tcoChart.update();
            }

            // 2. MONTHLY COST CHART (Grouped Bar)
            if (!monthlyCostChart) {
                monthlyCostChart = new Chart($('monthlyCostChart'), {
                    type: 'bar',
                    data: {
                        labels: ['EMI', 'Maintenance', 'Risk-Adj. Lease', 'Market Rent', 'Advantage'],
                        datasets: [
                            {
                                label: 'Actual Lease Outflow',
                                data: [data.monthly.emi, data.monthly.maintenance, null, null, null],
                                backgroundColor: 'rgba(255, 140, 58, 0.7)',
                                borderRadius: 6,
                                borderWidth: 0
                            },
                            {
                                label: 'Economic Lease Cost',
                                data: [null, null, data.monthly.riskRent, null, null],
                                backgroundColor: 'rgba(155, 89, 182, 0.7)',
                                borderRadius: 6,
                                borderWidth: 0
                            },
                            {
                                label: 'Current Market Rent',
                                data: [null, null, null, data.monthly.rent, null],
                                backgroundColor: 'rgba(46, 204, 113, 0.7)',
                                borderRadius: 6,
                                borderWidth: 0
                            },
                            {
                                label: 'Monthly Savings',
                                data: [null, null, null, null, data.monthly.advantage],
                                backgroundColor: data.monthly.advantage >= 0 ? 'rgba(46, 204, 113, 0.7)' : 'rgba(255, 77, 77, 0.7)',
                                borderRadius: 6,
                                borderWidth: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            datalabels: {
                                anchor: 'top',
                                align: 'center',
                                color: colors.text,
                                font: { weight: 'bold', size: 10 },
                                formatter: v => v ? formatINR(v) : ''
                            }
                        },
                        scales: {
                            y: {
                                ticks: { callback: v => formatINR(v), color: colors.muted },
                                grid: { color: colors.border }
                            },
                            x: {
                                ticks: { color: colors.muted },
                                grid: { display: false }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } else {
                monthlyCostChart.data.datasets[0].data = [data.monthly.emi, data.monthly.maintenance, null, null, null];
                monthlyCostChart.data.datasets[1].data = [null, null, data.monthly.riskRent, null, null];
                monthlyCostChart.data.datasets[2].data = [null, null, null, data.monthly.rent, null];
                monthlyCostChart.data.datasets[3].data = [null, null, null, null, data.monthly.advantage];
                monthlyCostChart.data.datasets[3].backgroundColor = data.monthly.advantage >= 0 ? 'rgba(46, 204, 113, 0.7)' : 'rgba(255, 77, 77, 0.7)';
                monthlyCostChart.update();
            }

            // 3. CUMULATIVE IMPACT (Line Chart - Most Important)
            if (!cumulativeImpactChart) {
                cumulativeImpactChart = new Chart($('cumulativeImpactChart'), {
                    type: 'line',
                    data: {
                        labels: data.cumulative.months,
                        datasets: [
                            {
                                label: 'Cumulative Lease Cost (Economic)',
                                data: data.cumulative.leaseCosts,
                                borderColor: 'rgba(255, 77, 77, 0.9)',
                                backgroundColor: 'rgba(255, 77, 77, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'Cumulative Market Rent',
                                data: data.cumulative.buyCosts,
                                borderColor: 'rgba(46, 204, 113, 0.9)',
                                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: {
                                ticks: { callback: v => formatINR(v), color: colors.muted },
                                grid: { color: colors.border }
                            },
                            x: {
                                ticks: { color: colors.muted },
                                grid: { display: false }
                            }
                        }
                    }
                });
            } else {
                cumulativeImpactChart.data.labels = data.cumulative.months;
                cumulativeImpactChart.data.datasets[0].data = data.cumulative.leaseCosts;
                cumulativeImpactChart.data.datasets[1].data = data.cumulative.buyCosts;
                cumulativeImpactChart.update();
            }

            // 4. SENSITIVITY CHART (Bubble/Scatter for Decision Robustness)
            if (!sensitivityChart) {
                sensitivityChart = new Chart($('sensitivityChart'), {
                    type: 'bubble',
                    data: {
                        datasets: [
                            {
                                label: 'Lease Advantage',
                                data: data.sensitivity.leaseAdvantage,
                                backgroundColor: 'rgba(255, 77, 77, 0.6)',
                                borderColor: 'rgba(255, 77, 77, 0.9)',
                                borderWidth: 1
                            },
                            {
                                label: 'Rent Advantage',
                                data: data.sensitivity.rentAdvantage,
                                backgroundColor: 'rgba(46, 204, 113, 0.6)',
                                borderColor: 'rgba(46, 204, 113, 0.9)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            datalabels: { display: false }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Scenario Index', color: colors.muted },
                                ticks: { callback: v => v, color: colors.muted },
                                grid: { color: colors.border }
                            },
                            y: {
                                title: { display: true, text: 'Rent Growth Change (%)', color: colors.muted },
                                ticks: { callback: v => v + '%', color: colors.muted },
                                grid: { color: colors.border }
                            }
                        }
                    }
                });
            } else {
                sensitivityChart.data.datasets[0].data = data.sensitivity.leaseAdvantage;
                sensitivityChart.data.datasets[1].data = data.sensitivity.rentAdvantage;
                sensitivityChart.update();
            }

            // 5. COST COMPOSITION PIE
            if (!costCompositionChart) {
                costCompositionChart = new Chart($('costCompositionChart'), {
                    type: 'doughnut',
                    data: {
                        labels: data.composition.labels,
                        datasets: [{
                            data: data.composition.values,
                            backgroundColor: [
                                'rgba(255, 77, 77, 0.8)',
                                'rgba(155, 89, 182, 0.8)',
                                'rgba(241, 196, 15, 0.8)',
                                'rgba(255, 140, 58, 0.8)'
                            ],
                            borderColor: colors.card,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'bottom' },
                            datalabels: {
                                color: colors.text,
                                font: { weight: 'bold', size: 11 },
                                formatter: (v, ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const percent = ((v / total) * 100).toFixed(1);
                                    return percent + '%';
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } else {
                costCompositionChart.data.labels = data.composition.labels;
                costCompositionChart.data.datasets[0].data = data.composition.values;
                costCompositionChart.update();
            }

            // 6. RENT PROJECTION
            if (!rentProjectionChart) {
                rentProjectionChart = new Chart($('rentProjectionChart'), {
                    type: 'line',
                    data: {
                        labels: data.rentProjection.months,
                        datasets: [
                            {
                                label: 'Market Rent (Escalating)',
                                data: data.rentProjection.monthlyRent,
                                borderColor: 'rgba(46, 204, 113, 0.9)',
                                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4,
                                pointRadius: 0
                            },
                            {
                                label: 'Lease Economic Cost (Fixed)',
                                data: data.rentProjection.leaseConstant,
                                borderColor: 'rgba(255, 77, 77, 0.9)',
                                backgroundColor: 'rgba(255, 77, 77, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4,
                                pointRadius: 0,
                                borderDash: [5, 5]
                            },
                            {
                                label: 'Cumulative Rent Burden',
                                data: data.rentProjection.cumulativeRent,
                                borderColor: 'rgba(255, 140, 58, 0.9)',
                                backgroundColor: 'rgba(255, 140, 58, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: 'Monthly Cost' },
                                ticks: { callback: v => formatINR(v), color: colors.muted },
                                grid: { color: colors.border }
                            },
                            y1: {
                                title: { display: true, text: 'Cumulative Cost' },
                                position: 'right',
                                ticks: { callback: v => formatINR(v), color: colors.muted },
                                grid: { drawOnChartArea: false }
                            },
                            x: {
                                ticks: { color: colors.muted },
                                grid: { display: false }
                            }
                        }
                    }
                });
            } else {
                rentProjectionChart.data.labels = data.rentProjection.months;
                rentProjectionChart.data.datasets[0].data = data.rentProjection.monthlyRent;
                rentProjectionChart.data.datasets[1].data = data.rentProjection.leaseConstant;
                rentProjectionChart.data.datasets[2].data = data.rentProjection.cumulativeRent;
                rentProjectionChart.update();
            }
        }

        /* ================= MAIN CALCULATION ================= */
        function calculate() {
            try {
                const LEASE_AMOUNT = num('leaseAmount');
                const LOAN_AMOUNT = num('loanAmount');
                const OWN_FUNDS = Math.max(0, LEASE_AMOUNT - LOAN_AMOUNT);

                const LOAN_INTEREST_RATE = (num('loanRate') / 100) / 12;
                const LOAN_TENURE = num('loanTenure');
                const LEASE_TENURE = num('leaseTenure');

                const WITHHOLDING = num('withholding') / 100;
                const REFUND_DELAY = num('refundDelay');

                const MAINTENANCE = num('maintenance');
                const MARKET_RENT = num('marketRent');
                
                // Rent Deposit Parameters
                const RENT_DEPOSIT = num('rentDeposit');
                const DEPOSIT_REFUND_DELAY = num('depositRefundDelay');

                const OPP_RATE = (num('oppRate') / 100) / 12;
                const RISK_PREMIUM = num('riskPremium') / 100;
                const RENT_INCREMENT = num('rentIncrement') / 100;

                // Validation
                if (LEASE_AMOUNT <= 0) return;
                if (LEASE_TENURE <= 0) return;
                if (LOAN_TENURE <= 0) return;
                if (MARKET_RENT <= 0) return;

                // 1. INPUTS & DERIVED BASICS
                // Clamp withholding to [0,1]
                const WITHHOLDING_CLAMPED = Math.min(1, Math.max(0, WITHHOLDING));
                // Prevent negative OWN_FUNDS if loan > lease amount
                const OWN_FUNDS_SAFE = Math.max(0, OWN_FUNDS);
                // Align loan tenure ‚Äî cannot exceed lease tenure
                const effectiveLoanMonths = Math.min(LOAN_TENURE, LEASE_TENURE);

                // 2. EMI ‚Äî zero-interest guard already handled by emi() function
                const EMI = emi(LOAN_AMOUNT, LOAN_INTEREST_RATE, effectiveLoanMonths);

                // 3. LEASE COST COMPONENTS
                const totalInterestPaid = (EMI * effectiveLoanMonths) - LOAN_AMOUNT;
                const withholdingLoss = LEASE_AMOUNT * WITHHOLDING_CLAMPED;
                const depositRefundable = LEASE_AMOUNT * (1 - WITHHOLDING_CLAMPED);

                // Opportunity cost of own funds locked in lease deposit (compound)
                const ownFundsOppCost = OWN_FUNDS_SAFE * (Math.pow(1 + OPP_RATE, LEASE_TENURE) - 1);

                // Delay cost ‚Äî compound (consistent with ownFundsOppCost)
                const delayCost = REFUND_DELAY > 0
                    ? depositRefundable * (Math.pow(1 + OPP_RATE, REFUND_DELAY) - 1)
                    : 0;

                // Alias for chart use
                const totalLeasePaymentOppCost = ownFundsOppCost;

                // 4. TOTAL LEASE COST
                // Maintenance is a real monthly cash outflow over the full lease tenure
                const totalMaintenanceCost = MAINTENANCE * LEASE_TENURE;
                const totalLeaseCostWithoutRisk = totalInterestPaid + withholdingLoss + ownFundsOppCost + delayCost + totalMaintenanceCost;

                // Risk premium applied to lease amount directly ‚Äî treats X% of total deposit value
                // as a risk buffer, always visible and meaningful regardless of other inputs
                const riskAdjustedLeaseCost = totalLeaseCostWithoutRisk + LEASE_AMOUNT * RISK_PREMIUM;

                // Single source of truth ‚Äî monthly lease cost
                const monthlyLeaseCost = riskAdjustedLeaseCost / LEASE_TENURE;
                const riskRent = monthlyLeaseCost; // alias used in charts

                // 5. RENT COST COMPONENTS
                // Annual increment: Y = floor((month-1)/12), applied as (1+RENT_INCREMENT)^Y
                let totalRentPaidOverLeaseTerm = 0;
                for (let month = 1; month <= LEASE_TENURE; month++) {
                    const Y = Math.floor((month - 1) / 12);
                    totalRentPaidOverLeaseTerm += MARKET_RENT * Math.pow(1 + RENT_INCREMENT, Y);
                }

                // Rent deposit opp cost ‚Äî compound over full lease tenure
                const rentDepositOppCost = RENT_DEPOSIT * (Math.pow(1 + OPP_RATE, LEASE_TENURE) - 1);

                // Rent deposit delay opp cost ‚Äî compound (consistent)
                const rentDepositDelayOppCost = DEPOSIT_REFUND_DELAY > 0
                    ? RENT_DEPOSIT * (Math.pow(1 + OPP_RATE, DEPOSIT_REFUND_DELAY) - 1)
                    : 0;

                const totalRentCostOverLeaseTerm = totalRentPaidOverLeaseTerm + rentDepositOppCost + rentDepositDelayOppCost;

                // Single source of truth ‚Äî monthly rent cost
                const monthlyRentCost = totalRentCostOverLeaseTerm / LEASE_TENURE;

                // 6. COMPARISON & SCORE
                const costAdvantage = totalRentCostOverLeaseTerm - riskAdjustedLeaseCost;

                // Division safety
                const costRatio = totalRentCostOverLeaseTerm === 0 ? 0 : riskAdjustedLeaseCost / totalRentCostOverLeaseTerm;

                // Simplified score ‚Äî mathematically equivalent to previous two-branch logic, cleaner
                const score = Math.max(0, Math.min(100, 100 - 50 * costRatio));

                // 7. DISPLAY METRICS ‚Äî all derived from the two monthly costs above
                const monthlySavings = monthlyRentCost - monthlyLeaseCost;
                const yearlySavings = monthlySavings * 12;
                const termSavings = monthlySavings * LEASE_TENURE;

                // Stabilized confidence: scale-independent, based on costRatio distance from 1
                const confidence = Math.max(0, Math.min(100, Math.abs(costRatio - 1) * 100));

                let color = '#f1c40f';
                let interpretation = 'üìä Balanced decision - Consider other factors';

                if (score >= 85) {
                    color = '#1abc9c';
                    interpretation = 'üéØ Excellent Leasing Advantage - Highly favorable to lease';
                } else if (score >= 65) {
                    color = '#2ecc71';
                    interpretation = '‚úÖ Strong Leasing Advantage - Leasing is recommended';
                } else if (score >= 50) {
                    color = '#f1c40f';
                    interpretation = 'üìä Marginal Leasing Advantage - Consider flexibility & other factors';
                } else if (score >= 35) {
                    color = '#ff9f43';
                    interpretation = '‚ö†Ô∏è Slight Renting Advantage - Renting is marginally better';
                } else {
                    color = '#ff4d4d';
                    interpretation = '‚ùå Strong Renting Advantage - Renting is significantly more economical';
                }

                // Update Gauge
                const gaugeDegrees = score * 3.6;
                $('gauge').style.background = `conic-gradient(${color} ${gaugeDegrees}deg, #1a2a38 ${gaugeDegrees}deg)`;
                $('dial').style.color = color;
                $('dial').innerText = Math.round(score);
                $('interpretation').innerText = interpretation;

                // Update Metrics
                $('mEMI').innerText = formatINR(EMI);
                $('mMaintenance').innerText = formatINR(MAINTENANCE);
                $('mSave').innerText = formatINR(monthlySavings);
                $('ySave').innerText = formatINR(yearlySavings);
                $('tSave').innerText = formatINR(termSavings);
                $('confidence').innerText = Math.round(confidence) + '%';

                // ========== PREPARE CHART DATA ==========

                // 1. TCO Data - The 5 components that make up total economic lease cost
                const tcoData = {
                    labels: ['Interest Paid', 'Withholding Loss', 'Own Funds Opp Cost', 'Refund Delay Cost', 'Total Maintenance'],
                    values: [
                        Math.max(0, totalInterestPaid),
                        Math.max(0, withholdingLoss),
                        Math.max(0, totalLeasePaymentOppCost),
                        Math.max(0, delayCost),
                        Math.max(0, totalMaintenanceCost)
                    ]
                };

                // 2. Monthly Cost Data
                const monthlyData = {
                    emi: EMI,
                    maintenance: MAINTENANCE,
                    rent: MARKET_RENT,
                    riskRent: riskRent,
                    advantage: monthlySavings
                };

                // 3. Cumulative Data - month-by-month running totals
                let cumulativeLeaseCosts = [];
                let cumulativeRentCosts = [];
                let cumulativeMonths = [];
                let cumulativeLeaseTotal = 0;
                let cumulativeRentTotal = 0;

                for (let m = 1; m <= LEASE_TENURE; m++) {
                    // Lease: spread risk-adjusted cost evenly across months
                    cumulativeLeaseTotal += riskRent;
                    
                    // Rent: apply annual escalation
                    const yearIndex = Math.floor((m - 1) / 12);
                    const monthlyMarketRent = MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yearIndex);
                    cumulativeRentTotal += monthlyMarketRent;
                    
                    cumulativeLeaseCosts.push(cumulativeLeaseTotal);
                    cumulativeRentCosts.push(cumulativeRentTotal);
                    cumulativeMonths.push('Y' + (Math.floor((m - 1) / 12) + 1) + 'M' + ((m % 12) || 12));
                }

                const cumulativeData = {
                    months: cumulativeMonths,
                    leaseCosts: cumulativeLeaseCosts,
                    buyCosts: cumulativeRentCosts
                };

                // 4. Sensitivity Data - varying rent levels vs fixed lease monthly cost
                const sensitivityLeaseAdvantage = [];
                const sensitivityRentAdvantage = [];

                for (let rateChange = -15; rateChange <= 15; rateChange += 3) {
                    for (let rentChange = -15; rentChange <= 15; rentChange += 3) {
                        const adjRent = MARKET_RENT * (1 + rentChange / 100);
                        // Savings = Adjusted Rent - Risk-Adjusted Lease monthly equivalent
                        const adjustedSavings = adjRent - riskRent;
                        const netDifference = Math.abs(adjustedSavings);
                        
                        // Positive savings = Rent > Lease cost = Lease advantage
                        if (adjustedSavings > 0) {
                            sensitivityLeaseAdvantage.push({
                                x: rateChange,
                                y: rentChange,
                                r: Math.min(30, Math.sqrt(netDifference / 100))
                            });
                        } else {
                            sensitivityRentAdvantage.push({
                                x: rateChange,
                                y: rentChange,
                                r: Math.min(30, Math.sqrt(netDifference / 100))
                            });
                        }
                    }
                }

                const sensitivityData = {
                    leaseAdvantage: sensitivityLeaseAdvantage,
                    rentAdvantage: sensitivityRentAdvantage
                };

                // 5. Cost Composition - same 5 components as TCO
                const compositionData = {
                    labels: ['Interest', 'Withholding', 'Own Funds Opp Cost', 'Refund Delay', 'Maintenance'],
                    values: [
                        Math.max(1, totalInterestPaid),
                        Math.max(1, withholdingLoss),
                        Math.max(1, totalLeasePaymentOppCost),
                        Math.max(1, delayCost),
                        Math.max(1, totalMaintenanceCost)
                    ]
                };

                // 6. Rent Projection - monthly rent escalation vs constant lease cost
                const rentMonthlyRent = [];
                const leaseConstantRent = [];
                const rentCumulativeRent = [];
                const rentMonths = [];
                let rentTotal = 0;

                for (let m = 1; m <= LEASE_TENURE; m++) {
                    const yearIndex = Math.floor((m - 1) / 12);
                    const monthlyRent = MARKET_RENT * Math.pow(1 + RENT_INCREMENT, yearIndex);
                    rentTotal += monthlyRent;
                    
                    rentMonthlyRent.push(monthlyRent);
                    leaseConstantRent.push(riskRent);
                    rentCumulativeRent.push(rentTotal);
                    rentMonths.push('M' + m);
                }

                const rentProjectionData = {
                    months: rentMonths,
                    monthlyRent: rentMonthlyRent,
                    leaseConstant: leaseConstantRent,
                    cumulativeRent: rentCumulativeRent
                };

                // Initialize all charts
                initCharts({
                    tco: tcoData,
                    monthly: monthlyData,
                    cumulative: cumulativeData,
                    sensitivity: sensitivityData,
                    composition: compositionData,
                    rentProjection: rentProjectionData
                });

                // Update Comparison Table
                updateComparisonTable(EMI, MAINTENANCE, riskRent, MARKET_RENT, monthlySavings, termSavings, LEASE_TENURE);

            } catch (error) {
                console.error('Calculation error:', error);
            }
        }

        function updateComparisonTable(emi, maintenance, economicCost, rentCost, advantage, termAdvantage, leaseTenure) {
            const tbody = $('comparisonBody');
            const leaseBetter = advantage > 0;
            const actualLeaseOutflow = emi + maintenance;
            
            tbody.innerHTML = `
                <tr>
                    <td><strong>Monthly EMI</strong></td>
                    <td class="metric-negative">${formatINR(emi)}</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td><strong>Monthly Maintenance</strong></td>
                    <td class="metric-negative">${formatINR(maintenance)}</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td><strong>Actual Monthly Lease Outflow</strong></td>
                    <td class="metric-negative">${formatINR(actualLeaseOutflow)}</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td><strong>Monthly Rent</strong></td>
                    <td>-</td>
                    <td class="metric-negative">${formatINR(rentCost)}</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td><strong>Monthly Cost (Economic)</strong></td>
                    <td class="${leaseBetter ? 'metric-positive' : 'metric-negative'}">${formatINR(economicCost)}</td>
                    <td class="${leaseBetter ? 'metric-negative' : 'metric-positive'}">${formatINR(rentCost)}</td>
                    <td class="${advantage >= 0 ? 'metric-positive' : 'metric-negative'}">${formatINR(Math.abs(advantage))}</td>
                </tr>
                <tr>
                    <td><strong>Annual Impact</strong></td>
                    <td class="${leaseBetter ? 'metric-positive' : 'metric-negative'}">${formatINR(economicCost * 12)}</td>
                    <td class="${leaseBetter ? 'metric-negative' : 'metric-positive'}">${formatINR(rentCost * 12)}</td>
                    <td class="${advantage >= 0 ? 'metric-positive' : 'metric-negative'}">${formatINR(Math.abs(advantage) * 12)}</td>
                </tr>
                <tr>
                    <td><strong>Lease Term Total</strong></td>
                    <td class="${leaseBetter ? 'metric-positive' : 'metric-negative'}">${formatINR(economicCost * leaseTenure)}</td>
                    <td class="${leaseBetter ? 'metric-negative' : 'metric-positive'}">${formatINR(rentCost * leaseTenure)}</td>
                    <td class="${advantage >= 0 ? 'metric-positive' : 'metric-negative'}">${formatINR(Math.abs(termAdvantage))}</td>
                </tr>
            `;
        }

        /* ================= EVENT LISTENERS ================= */
        let calculationTimer = null;
        document.querySelectorAll('input').forEach(el => {
            el.addEventListener('input', () => {
                if (calculationTimer) clearTimeout(calculationTimer);
                calculationTimer = setTimeout(calculate, 300);
            });
        });

        // Initial Calculation
        window.addEventListener('load', calculate);
        calculate();

    </script>
</body>

</html>
